metadata:
  name: consume-food
  labels:
    nuclio.io/project-name: c9af2e9d-c13e-49a8-9b53-0ce4b6eb1be1
spec:
  handler: "main:handler"
  runtime: nodejs
  resources: {}
  image: "nuclio/processor-consume-food:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    food-trigger:
      class: ""
      kind: mqtt
      url: "guest:guest@10.0.2.15:1883"
      username: guest
      password: guest
      attributes:
        subscriptions:
          - qos: 0
            topic: iot/sensors/food
  build:
    functionSourceCode: dmFyIGFtcXAgPSByZXF1aXJlKCdhbXFwbGliJyk7CnZhciBGVU5DVElPTl9OQU1FID0gIm1xdHRjb25zdW1lIjsKdmFyIERJU1BFTlNFUl9GT09EID0gMzsKCmZ1bmN0aW9uIGRpc3BlbnNlcihtc2cpIHsKICB2YXIgcSA9ICJpb3QvZGlzcGVuc2VyIjsKICBESVNQRU5TRVJfRk9PRC0tOwogIGlmKERJU1BFTlNFUl9GT09EIDwgMCl7CiAgICBhbXFwCiAgICAuY29ubmVjdCgiYW1xcDovL2d1ZXN0Omd1ZXN0QDEwLjAuMi4xNTo1NjcyIikKICAgIC50aGVuKGZ1bmN0aW9uIChjb25uKSB7CiAgICAgICAgcmV0dXJuIGNvbm4KICAgICAgICAuY3JlYXRlQ2hhbm5lbCgpCiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgICAgIHZhciBvayA9IGNoLmFzc2VydFF1ZXVlKHEsIHsgZHVyYWJsZTogZmFsc2UgfSk7CiAgICAgICAgICAgIHJldHVybiBvay50aGVuKGZ1bmN0aW9uIChfcW9rKSB7CiAgICAgICAgICAgICAgICBjaC5zZW5kVG9RdWV1ZShxLCBCdWZmZXIuZnJvbShtc2cpKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCIgW3hdIFNlbnQgJyVzJyIsIG1zZyk7CiAgICAgICAgICAgICAgICByZXR1cm4gY2guY2xvc2UoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSkKICAgICAgICAuZmluYWxseShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGNvbm4uY2xvc2UoKTsKICAgICAgICB9KTsKICAgIH0pCiAgICAuY2F0Y2goY29uc29sZS53YXJuKTsKICAgIH0gICAKfQoKZnVuY3Rpb24gc2VuZF9mZWVkYmFjayhtc2cpewogICAgdmFyIHEgPSAnaW90L2xvZ3MnOwogICAgYW1xcC5jb25uZWN0KCdhbXFwOi8vZ3Vlc3Q6Z3Vlc3RAMTAuMC4yLjE1OjU2NzInKS50aGVuKGZ1bmN0aW9uKGNvbm4pIHsKICAgICAgICByZXR1cm4gY29ubi5jcmVhdGVDaGFubmVsKCkudGhlbihmdW5jdGlvbihjaCkgewogICAgICAgICAgICB2YXIgb2sgPSBjaC5hc3NlcnRRdWV1ZShxLCB7ZHVyYWJsZTogZmFsc2V9KTsKICAgICAgICAgICAgcmV0dXJuIG9rLnRoZW4oZnVuY3Rpb24oX3FvaykgewogICAgICAgICAgICAgICAgY2guc2VuZFRvUXVldWUocSwgQnVmZmVyLmZyb20obXNnKSk7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiIFt4XSBTZW50ICclcyciLCBtc2cpOwogICAgICAgICAgICAgICAgcmV0dXJuIGNoLmNsb3NlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pLmZpbmFsbHkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNvbm4uY2xvc2UoKTsKICAgICAgICB9KTsKICAgIH0pLmNhdGNoKGNvbnNvbGUud2Fybik7Cn0KCmZ1bmN0aW9uIGJpbjJzdHJpbmcoYXJyYXkpewogICAgdmFyIHJlc3VsdCA9ICIiOwogICAgZm9yKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgKytpKXsKICAgICAgICByZXN1bHQrPSAoU3RyaW5nLmZyb21DaGFyQ29kZShhcnJheVtpXSkpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKfQoKZXhwb3J0cy5oYW5kbGVyID0gZnVuY3Rpb24oY29udGV4dCwgZXZlbnQpIHsKICAgIHZhciBfZXZlbnQgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGV2ZW50KSk7CiAgICB2YXIgX2RhdGEgPSBiaW4yc3RyaW5nKF9ldmVudC5ib2R5LmRhdGEpOwogICAgdmFyIGZvb2QgPSBwYXJzZUludChfZGF0YSk7CiAgICBzZW5kX2ZlZWRiYWNrKCIiICsgZm9vZCk7CiAgICBpZihmb29kIDw9IDQwKXsKICAgICAgICBkaXNwZW5zZXIoIiIgKyBmb29kKTsKICAgIH0KICAgIGNvbnRleHQuY2FsbGJhY2soIlNlbnQgZm9vZDogIiArIGZvb2QpOwp9Ow==
    commands:
      - 'npm install amqplib'
    runtimeAttributes:
      repositories: []
    codeEntryType: sourceCode
  platform: {}
  readinessTimeoutSeconds: 60
  version: 1
